<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chat en vivo con GO</title>
	<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body>
	<div>
			<h1>Live chat with GO</h1>
			<h3 id="chat-header">Currently you are in chat: general</h3>
			<h3 id="connection-header">Connected to websocket: false</h3>
			<form id="chatroom-selection"action="">
				<label for="chatroom">Chatroom:</label>
				<input type="text" id="chatroom" name="chatroom"/>
				<input type="submit" value="Change chatroom" >
			</form>

			<textarea class="messagearea" readonly id="chatmessages" name="chatmessages" rows="5" cols="10" placeholder="Welcome!"></textarea>
			<form id="chatroom-message">
				<label for="message">Message:</label>
				<input type="text" name="message" id="message">
				<input type="submit" value="Send message">
			</form>

			<div>
				<form id="login-form">
					<label for="username">Username</label>
					<input type="text" id="username" name="username"/>
					<label for="password">Password</label>
					<input type="password" id="password" name="password" />
					<input type="submit" value="Login"/>

				 
				</form>
			</div>
	</div>	
	<script>
		var selectedChat = "general"

		class Event {
			constructor(type, payload){
				this.type = type;
				this.payload = payload;
			}
		}

		function routeEvent(event){
			if (event.type === undefined){
				alert('No field type')
			}

			switch(event.type){
				case "new_message":
				console.log("new message")
				break;
				default:
				alert("unsupported event type")
				break;
			}
		}

		function sendEvent(eventName, payload){
			const event = new Event(eventName, payload)
			conn.send(JSON.stringify(event))
		}

		function changeChatRoom(){
			var newChat = document.getElementById("chatroom")
			if(newChat != null && newChat.value != selectedChat){
				console.log(newChat)

			}
			return false;
		}


		function sendMessage(){
				var newMessage = document.getElementById("message")
			if(newMessage != null ){
				sendEvent("send_message", newMessage.value )

			}
			return false;

		}
		function login(){
			let formData = {
				"username": document.getElementById("username").value,
				"password": document.getElementById("password").value,
			}

			fetch("login", {
				method: 'post',
				body: JSON.stringify(formData),
				mode:'cors'
			}).then((response) => {
					if (response.ok){
						return response.json()
					}else{
						throw 'unauthorized'
					}
				}).then((data) => {
					connectWebsocket(data.otp);
				}).catch((e) => {alert(e)})
			return false
		}

		function connectWebsocket(otp){
			if(window["WebSocket"]){
				console.log("connect to websocket")
				conn = new WebSocket(`wss://${document.location.host}/ws?otp=${otp}`)
				conn.onopen = function (evt){
				document.getElementById("connection-header").innerHTML = "Connected!"				
				}
				conn.onopen = function (evt){
					document.getElementById("connection-header").innetHTML = "Disconnected..."
					// reconnection

				}

				conn.onmessage = function(evt) {
					const eventData = JSON.parse(evt.data)
					const event = Object.assign(new Event, eventData)

					routeEvent(event)
				}
			}else{
				alert("the browser does not support WebSocket")
			}

		}

		window.onload = function() {
			document.getElementById("chatroom-selection").onsubmit = changeChatRoom
			document.getElementById("chatroom-message").onsubmit = sendMessage
			document.getElementById("login-form").onsubmit = login
					}
		</script>
</body>
</html>
